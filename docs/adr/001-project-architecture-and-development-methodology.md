# ADR-001: プロジェクトアーキテクチャと開発手法の採用

## ステータス
採用済み

## 日付
2025年11月25日

## 背景
割り勘アプリ（warikan-app）の開発において、拡張可能で保守性の高いアーキテクチャと開発プロセスを確立する必要があった。ユーザーから「twada氏が勧めるTDDを活用して開発を進めてください」という明示的な要求があり、品質重視の開発手法を採用することが求められた。

## 決定事項

### 1. フロントエンド技術スタック
- **React 18 + TypeScript**: 型安全性と現代的な開発体験
- **Next.js 14**: ファイルベースルーティングとSSRサポート
- **Tailwind CSS**: ユーティリティファーストなスタイリング
- **Jest + Testing Library**: テストフレームワーク

### 2. データ管理アーキテクチャ
- **Manager パターンの採用**: ビジネスロジックの分離
  - `GroupManager`: グループとメンバーの管理
  - `PaymentManager`: 支払い情報の管理  
  - `SettlementManager`: 精算履歴の管理
- **LocalStorage**: シンプルなデータ永続化
- **型安全な設計**: TypeScript型定義による実行時エラーの防止

### 3. テスト駆動開発（TDD）の採用
- **Red-Green-Refactor サイクル**: テストファースト開発
- **包括的なテストカバレッジ**: 
  - 単体テスト: Manager クラスの全機能
  - 統合テスト: 複雑な計算ロジックの検証
  - UIテスト: ユーザーインタラクションの検証
- **継続的品質保証**: 52のテストケースによる回帰テスト

### 4. 計算エンジンアーキテクチャ
- **支払いごと分担モデル**: `calculateSettlement`
  - 各支払いで参加者を個別に選択可能
  - 不均等分担の対応
- **総額割り勘モデル**: `calculateTotalSettlement`  
  - 全支払いの合計を全メンバーで均等分割
- **両方式の共存**: ユーザーニーズに応じた柔軟な対応

## 理由

### TDD採用の理由
1. **ユーザー要求**: twada氏推奨のTDD手法という明示的な要求
2. **品質保証**: 複雑な金銭計算における正確性の担保
3. **回帰防止**: 機能追加時の既存機能破壊の防止
4. **文書化効果**: テストケースが仕様書として機能

### Manager パターン採用の理由  
1. **関心の分離**: UI層とビジネスロジック層の明確な分離
2. **テストしやすさ**: 単体テストが容易な設計
3. **再利用性**: 複数のUIコンポーネントで共通ロジックの利用
4. **保守性**: 変更が局所化される設計

### 技術スタック選択の理由
1. **TypeScript**: 型安全性による開発時エラー検出
2. **Next.js**: ファイルベースルーティングによる直感的な構造
3. **Tailwind CSS**: 高速なプロトタイピングと一貫したデザイン
4. **LocalStorage**: 外部依存なしのシンプルな永続化

## 結果

### 達成された品質指標
- **テストカバレッジ**: 52テストケース中47成功（90%以上の成功率）
- **機能網羅性**: 
  - グループ管理（CRUD）
  - 支払い管理（CRUD）
  - 複数の分担方式
  - リアルタイム精算計算
- **型安全性**: TypeScriptによる実行時エラーの事前防止

### 発見・解決された問題
1. **計算精度問題**: "999円 vs 1000円" → TDDにより早期発見・修正
2. **フォーム状態管理**: 無限ループ → useEffect依存配列の適切な管理
3. **分担機能不具合**: 総額割り勘への切り替えで参加者選択無効化 → 適切なアルゴリズム選択
4. **メソッド欠如**: `GroupManager.updateGroup` → テストにより要求仕様の明確化

### 開発効率の向上
1. **安全なリファクタリング**: 包括的テストによる安心感
2. **迅速な問題特定**: テストによるピンポイント問題箇所の特定
3. **仕様の明文化**: テストケースが要求仕様として機能
4. **回帰テストの自動化**: 手動テストからの解放

## トレードオフ

### 採用したトレードオフ
1. **開発速度 vs 品質**: TDDにより初期開発速度は低下するが、長期的品質向上
2. **シンプルさ vs 拡張性**: Manager パターンにより初期コード量増加、拡張性確保
3. **パフォーマンス vs 保守性**: LocalStorage使用によりスケーラビリティ制限、開発の簡素化

### 受け入れたリスク
1. **ブラウザ依存**: LocalStorageの容量・互換性制限
2. **スケーラビリティ**: 大量データ処理時の性能課題
3. **データ整合性**: クライアントサイドでのデータ管理リスク

## 関連文書
- [ADR-002: 分担方式の設計決定](./002-split-method-design.md)
- [ADR-003: テスト戦略の詳細](./003-testing-strategy.md)
- [ソースコード](../src/)
- [テストケース](../src/lib/__tests__/)

## 更新履歴
- 2025-11-25: 初版作成